{% extends 'base_distributed.html' %}

{% block update_selected %}selected{% endblock update_selected %}

{% block title %}Video Download{% endblock %}

{% block headcss %}
<link href="{{ STATIC_URL }}css/ui.dynatree.css"rel="stylesheet" type="text/css"/>
<style>

.download-actions {
    width: 400px;
    float: left;
    margin-right: 10px;
    height: 60px;
    padding: 10px;
}

.progress-section {
    padding: 5px 0px 0px 0px;
    display: none;
}

.progress-waiting {
    padding: 5px 0px 0px 0px;
    display: none;
}

.progress-text {
    color: #005987;
    margin-top: 1.5px;
}


#progressbar-current {
    opacity: 0.9;
    height: 7px;
    margin-top: -7px;
    margin-bottom: 9px;
}

#progressbar-overall {
    opacity: 0.9;
    height: 12px;
    margin-top: -7px
}

#progressbar-overall .ui-widget-header {
    background: #00A000;
}

#progressbar-current .ui-widget-header {
    background: #00AFD0;
}

#download-legend-selected, #download-videos {
    display: none;
}

#content_tree {
    margin-top: 15px;
}

</style>
{% endblock headcss %}
{% block headjs %}
<script src="{{ STATIC_URL }}js/jquery-ui.custom.min.js"></script>
<script src="{{ STATIC_URL }}js/jquery.dynatree.min.js"></script>

<script type="text/javascript">

    window.downloading_videos = [];
    window.download_index = 0;
    
    window.download_check_interval = null;
    
    $(function() { 
        
        doRequest("/api/get_topic_tree", {}).success(function(treeData) {
            
            $("#content_tree").dynatree({
                imagePath:"../images/",
                checkbox: true,
                selectMode: 3,
                children: treeData,
                onSelect: function(select, node) {
                
                    var numberOfVideos = findSelectedIncompleteVideos().length;
                    
                    if (numberOfVideos > 0) {
                        $(".video_count").text(numberOfVideos);
                        $("#download-legend-selected").show();
                        $("#download-legend-unselected").hide();
                        $("#download-videos").show();
                    } else {
                        $("#download-legend-unselected").show();
                        $("#download-legend-selected").hide();
                        $("#download-videos").hide();
                    }

                },
                onDblClick: function(node, event) {
                    node.toggleSelect();
                },
                onKeydown: function(node, event) {
                    if( event.which == 32 ) {
                        node.toggleSelect();
                        return false;
                    }
                },
            });
                    
        });
        
       
    
        $("#progressbar-overall").progressbar({
            value: 0,
            max: 10000000
        });

        $("#progressbar-current").progressbar({
            value: 0,
            max: 100
        });
    
        $("#download-videos").click(function() {
            var videos = findSelectedIncompleteVideos();
            
            var video_ids = $.map(videos, function(node) {
           		node.select(false);
                return node.data.key;
            });
                    
            doRequest("/api/start_video_download", {youtube_ids: video_ids}).success(startDownloadChecks);
    	
            $(".progress-section").hide();
            $(".progress-waiting").show();
                 
    
        });
        
       
        startDownloadChecks();
    
    });
    
    function startDownloadChecks() {
        doRequest("/api/get_video_download_list").success(function(video_ids) {
            window.downloading_videos = video_ids;
            window.download_index = 0;
            clearInterval(window.download_check_interval);
            if (video_ids.length == 0) {
                return;
            }
            window.download_check_interval = setInterval(checkVideoDownloadProgress, 1000);
            checkVideoDownloadProgress();
        });
    }
    
    function checkVideoDownloadProgress() {
        var currentKey = window.downloading_videos[window.download_index];
        doRequest("/api/check_video_download", {youtube_ids: [currentKey]}).success(function(progress) {
            window.current_download_percent = progress[currentKey];
            updateProgressDisplay();
            if (window.current_download_percent == 100) {
                setNodeClass(currentKey, "complete");
                window.download_index++;
                if (window.download_index >= window.downloading_videos.length) {
                    clearInterval(window.download_check_interval);
                    $(".progress-section").hide();
                    return;
                }
                checkVideoDownloadProgress();
            }
        });
    }
    
    function updateProgressDisplay() {
        if (window.download_index < window.downloading_videos.length) {
            if (download_index > 0 || current_download_percent > 0) {
            	 $(".progress-section").show();
            	 $(".progress-waiting").hide();
    	 	} else {
            	 $(".progress-section").hide();
            	 $(".progress-waiting").show();	
        	}
            
        } else {
            $(".progress-section").hide();
            return;
        }
        
        $("#progressbar-current").progressbar({value: window.current_download_percent});
        $("#progressbar-overall").progressbar({
            value: window.download_index * 100 + window.current_download_percent,
            max: window.downloading_videos.length * 100
        });
        var currentKey = window.downloading_videos[window.download_index];
        var currentNode = $("#content_tree").dynatree("getTree").getNodeByKey(currentKey);
        $(".video-title").text(currentNode.data.title);
        $(".video-downloading-current").text(window.download_index + 1);
        $(".video-downloading-total").text(window.downloading_videos.length);
    }
    
    function findSelectedIncompleteVideos() {
        var arr = $("#content_tree").dynatree("getSelectedNodes");
        return $.grep(arr, function(node) { 
            return node.data.addClass != "complete" && node.childList == null;
        });
    }
    
    function getNode(nodeKey) {
        return $("#content_tree").dynatree("getTree").getNodeByKey(nodeKey);
    }
    
    function setNodeClass(nodeKey, className) {
        var node = getNode(nodeKey);
        $(node.span).removeClass("unstarted partial complete").addClass(className);
        node.data.addClass = className;
        if (node.parent) {
            updateNodeClass(node.parent);
        }
    }

    function updateNodeClass(node) {
        if (node.childList) {
            var complete = true;
            var unstarted = true;
            for (var i = 0; i < node.childList.length; i++) {
                var child = node.childList[i];
                if (child.data.addClass != "complete") {
                    complete = false;
                }
                if (child.data.addClass != "unstarted") {
                    unstarted = false;
                }
            }
            if (complete) {
                setNodeClass(node.data.key, "complete");
            } else if (unstarted) {
                setNodeClass(node.data.key, "unstarted");
            } else {
                setNodeClass(node.data.key, "partial");
            }
        }
    }

</script>

{% endblock headjs %}

{% block content %}

<div class="download-actions vertical-shadow">
    <h2 id="download-legend-unselected" class="button_text">Please select videos to download (below)</h2>
    <h2 id="download-legend-selected" class="button_text">Download <span class="video_count">0</span> videos selected below </h2>
    <button id="download-videos" type="button">Download Selected Videos</button>
</div>

<div class="download-actions vertical-shadow">
    <h2 class="button_text">Download/update subtitles for all videos</h2>
    <span class= "button_style">
        <select id="language">
            <option value="chinese">English</option>
            <option value="chinese">Chinese</option>
            <option value="spanish">Spanish</option>
            <option value="French">French</option>
            <option value="japanese">Japanese</option>
        </select>
    </span>
    <button id="download_subtitles" type="button">Download Subtitles</button>
</div>

<div style="clear: both;"></div>

<div class="progress-waiting">
	<h2 class="progress-text">
        Download will start soon...
    </h2>
</div>

<div class="progress-section">
    
    <h2 class="progress-text">
        Downloading video:
        "<span class="video-title"> </span>"...
    </h2>
    
        <div class="progressbar" id="progressbar-current"></div>
        
   <h2 class="progress-text">
        Overall download progress:
        <span class="video-downloading-current">6</span>
        of
        <span class="video-downloading-total">11</span>
    </h2>     
        
        
        <div class="progressbar" id="progressbar-overall"></div>
</div>

<div id="content_tree"><br/><h2>Loading topic tree... Please wait!</h2></div>

{% endblock content %}
