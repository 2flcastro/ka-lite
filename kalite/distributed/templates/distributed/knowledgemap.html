{% extends base_template %}
{% load i18n %}
{% load staticfiles %}

{% block practice_active %}active{% endblock practice_active %}

{% block headcss %}{{ block.super }}
    <link rel='stylesheet' type='text/css' href='{% static "css/distributed/kmap_editor.css" %}' />
    <link rel='stylesheet' type='text/css' href='{% static "css/distributed/tipsy.css" %}' />
{% endblock headcss %}

{% block headjs %}{{ block.super }}
    <!-- START PERSEUS STUFF -->
    <script src="{% static "perseus/lib/es5-shim.js" %}"></script>
    <script src="{% static "perseus/lib/marked.js" %}"></script>
    <script src="{% static "perseus/lib/react-with-addons.js" %}"></script>
    <script src="{% static "perseus/ke/third_party/MathJax/2.1/MathJax.js" True %}?config={% static "perseus/ke/third_party/MathJax/2.1/config/KAthJax-8f02f65cba7722b3e529bd9dfa6ac25d" %}"></script>
    <script src="{% static "perseus/lib/katex/katex.js" %}"></script>
    <script src="{% static "perseus/lib/mathquill/mathquill.js" %}"></script>
    <script src="{% static "perseus/lib/kas.js" %}"></script>
    <script src="{% static "perseus/ke/local-only/jed.js" %}"></script>
    <script src="{% static "perseus/ke/local-only/i18n.js" %}"></script>
    <script src="{% static "perseus/ke/local-only/jquery.qtip.js" %}"></script>
    <script src="{% static 'js/distributed/software-keyboard.js' %}"></script>
    <script src="{% url 'handlebars_templates' module_name='exercise' %}"></script>
    <script src="{% static 'js/seedrandom.min.js' %}"></script>
    <script src="{% static 'js/distributed/exercises/models.js' %}"></script>
    <script src="{% static 'js/distributed/exercises/views.js' %}"></script>
    <script src="{% static 'js/distributed/exercises/perseus-helpers.js' %}"></script>
    <script src="{% static 'perseus/ke/interface.js' %}"></script>
    <script src="{% static 'js/distributed/jquery.tipsy.js' %}"></script>
    <!-- END PERSEUS STUFF -->

    <script src="{% url 'handlebars_templates' module_name='map' %}"></script>
    <script src="{% static 'js/leaflet.js' %}"></script>
    <script type="text/javascript">
        var TOPIC_DATA_URLS = {
            Domains: '{{ data_url }}/map_domains.json',
            Subjects: '{{ data_url }}/map_subjects.json',
            Topics: '{{ data_url }}/map_topics.json',
            Tutorials: '{{ data_url }}/map_tutorials.json',
            Exercises: '{{ data_url }}/exercises.json'
        }
    </script>

<!-- need to move to separated css file later -->
    <style>
      .node text {
        font: 10px sans-serif;
        pointer-events: none;
        text-anchor: middle;
      }

    <script src="{% static 'js/distributed/map/models.js' %}"></script>
    <script src="{% static 'js/distributed/map/views.js' %}"></script>
    <script src="{% static 'js/distributed/topics/router.js' %}"></script>
    <script src="{% static 'js/distributed/map/router.js' %}"></script>
    <script type="text/javascript">
        $(function() {
            window.channel_router = new MapChannelRouter({default_channel: "{{ channel }}"})
            Backbone.history.start({pushState: true, root: "{% url 'exercise_dashboard' %}"});
        });
    </script>
      .desc-tip{
        font-size: 18px;
        margin-top: -34px;
      }

      .desc-tip .tipsy-inner{
        -webkit-border-radius: 10px;
        -moz-border-radius: 10px;
        border-radius: 10px;
        max-width: 400px;
        box-shadow: 0px 0px 17px #28333D;
        -webkit-box-shadow: 0px 0px 17px #28333D;
        -moz-box-shadow: 0px 0px 17px #28333D; 
        border: solid 1px rgba(255, 255, 255, 0.25);
      }

      div span {
        height: 100%; 
        vertical-align: middle; 
        display: inline-block;
      }

      div h {
        margin: 0; 
        vertical-align: 
        middle; display: 
        inline-block;
      }
    </style>

{% endblock headjs %}

{% block content %}
var user_exercises_json;
var url = "/api/coachreports/KnowledgeMapExerciselog/?"; 
doRequest(url)
        .success(function(user_json) {
          user_exercises_json = user_json;
          // console.log("user_exercises_json: ", user_exercises_json);

//create the hashtatble 
var user_hashtable = {};
for (var key in user_exercises_json["objects"]) {
  user_hashtable[user_exercises_json["objects"][key].exercise_id] = user_exercises_json["objects"][key];
}

// color-order: math_blue/sifi_scarlet/econ_orange/artist_red/cyber_green/test_purple/partner_emerald/college_pink
var color_scheme_array = ["#1c758a","#94424f","#c78d46","#cf5044","#699c52","#644172","#49a88f","#e89cb9"];

var subject_list = [];

var force = d3.layout.force()
  // // .theta(.0001)
  // .alpha(0.1)
  .size([width, height]);
  // .on("tick", tick);
  .call(d3.behavior.zoom().scaleExtent([0.1, 3]).on("zoom", zoomHandler))
var label_tanslate;
var label_scale;
function zoomHandler() {
  label_tanslate = d3.event.translate;
  label_scale = d3.event.scale;
  svg.attr("transform", "translate(" + label_tanslate + ")scale(" + label_scale + ")");
}
var initialized =false;

d3.json(sprintf(TOPIC_DATA_URLS.Topics, {channel_name: "khan"}), function(error, json) {
    root = json;

    for(var c in root.children){
      subject_list[c] = root.children[c].slug;

      // //create subject buttons here:
      // var subj_btn = document.createElement("div");
      // subj_btn.className = "subj_btn"

      // subj_btn.style.background=color_scheme_array[c];
      // subj_btn.style.textAlign = "center";
      // subj_btn.style.color = "white";
      // subj_btn.style.width = "100px";
      // subj_btn.style.height = "100px";
      // subj_btn.style.border = "solid 5px white";
      // subj_btn.style.borderRadius = "50%";
      // subj_btn.style.position = 'absolute';
      // subj_btn.style.top = subj_btn_top + 'px';
      // subj_btn.style.left = subj_btn_left + 'px';
      // subj_btn.innerHTML = "<span></span>" + "<h>" + root.children[c].title + "</h>";

      // document.body.appendChild(subj_btn);
      // subj_btn_top += 100;
    }

    // $(document).ready(function(){
    //   $(".subj_btn").click(function(){
    //     update();
    //   });
    // });
    // subj_btn.onclick = function(){update()};
    // console.log("topics_json: ", root);
    update();
});
var loading = svg.append("text")
    .attr("x", width / 2)
    .attr("y", height / 2)
    .attr("dy", ".35em")
    .style("text-anchor", "middle")
    .text("Simulating. One moment pleaseâ€¦");
var links_table = {}; //for link look up
var nodes;
  force.linkDistance(function(d){ 
    if(d.target.kind !== "Topic"){
      return  d.source.children.length * 1 + d.source.title.length * 1.5; 
    }else{
      return  d.source.children.length * 4 + d.target.title.length * 5; 
    }
  })
  .linkStrength(function(d){
    if(d.target.kind !== "Topic"){
      return 1;
    }else if(d.source.kind == "Subject"){
      return 7;
    }
    else{
      return 7.5;
    }
  })
  .charge(function(d){
    if(d.kind == "Exercise" || d.kind == "Video"){
      return -4000;
    }else if(d.kind == "Topic"){
      return d.title.length*(-2000);
    }else{
      return -70000;
    }
  })
  .chargeDistance(20000/unfold_scale_factor)
  .gravity(.912)
  .friction(0.2);
    loading.remove();
  }, 10);
  if(initialized){
    nodes = flatten(root);
  }else{
    initialized = true;
    nodes = initial(root);
  }
    .attr("stroke", colorline);
    for(var l = 0; l < link[0].length; l++){
      links_table[link[0][l].__data__.source.slug + "," + link[0][l].__data__.target.slug] = link[0][l];
    }
        .on("click", click)
        .on("mouseover", highlight_path)
        .on("mouseout", recover_highlight);
    node.select("rect")
        .attr("stroke-width", 4)
        .attr("stroke", colornode_stroke)
        .style("fill", colornode_fill);
        .style("fill", init_text_fill)
        .style("font-size", "14")
        .call(wrap, 130);
        .style("fill", "white")
        .text(function(d) { 
        .call(wrap, 90);
    node.select("circle")
        .attr("stroke-width", 4)
        .attr("stroke", colornode_stroke)
        .style("fill", colornode_fill);
    $(".node").tipsy({ 
      gravity: 's',
      className: 'desc-tip',
      // fade: true,
      offset: 0,
      opacity: 0.7,
      html: true, 
      title: function() {
              var d = this.__data__;
              if(d.kind == 'Video'){
              return '<span class="nameD-tip">' + d.title + '  </span>' + '<img src=' + "{% static 'images/distributed/search-video-available.png' %}" + '/>'; 
              }else if(d.kind == 'Exercise'){
                return '<span class="nameD-tip">' + d.title + '  </span>' + '<img src=' + "{% static 'images/distributed/search-exercise-available.png' %}" + '/>'; 
              }else{
                return '<span class="nameD-tip">' + d.title + '</span>';
              }
            } 
    });

    <div id="map-container">
    </div>
    <div id="overlay">
        <a href="#" class="close btn btn-danger">X</a>
        <div id="content-area">
            <div class="content"></div>
        </div>
    </div>
    <div id="fade"></div>
//this wrap function probably not flexable enough for longer string.
function wrap(text, width) {
  text.each(function() {
    var text = d3.select(this),
        words = text.text().split(/\s+/).reverse(),
        word,
        line = [],
        lineNumber = 0,
        lineHeight = 1.1, // ems
        y = text.attr("y"),
        dy = parseFloat(text.attr("dy")),
        tspan = text.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
    while (word = words.pop()) {
      if(word.indexOf('%') !== -1){
        line.push(word);
        tspan.text(line.join(" "));
        if(text.text().length > 15){
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + -1.15 + "em").text(word);
        }else{
          line.pop();
          tspan.text(line.join(" "));
          line = [word];
          tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + 0.1 + "em").text(word);
        }
      }else{
        line.push(word);
        tspan.text(line.join(" "));
      }
      if (tspan.node().getComputedTextLength() > width) {
        line.pop();
        tspan.text(line.join(" "));
        line = [word];
        tspan = text.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
      }
    }
  });
}


function tick() { 
  link.attr("x1", function(d) { return d.source.x; })
      .attr("y1", function(d) { return d.source.y; })
      .attr("x2", function(d) { return d.target.x; })
      .attr("y2", function(d) { return d.target.y; });

  node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
}

function init_text_fill(d) {
    var subject_domain = d.path.split("/")[1];
    var color_code = subject_list.indexOf(subject_domain);
    var assigned_color = color_scheme_array[color_code];

    return d._children != null &&  d._children[0] != null ? "white" //    collapsed package
        : d.children ? assigned_color // expanded package
        : assigned_color;
}

function text_fill(d) {
    var subject_domain = d.path.split("/")[1];
    var color_code = subject_list.indexOf(subject_domain);
    var assigned_color = color_scheme_array[color_code];
    return d._children != null &&  d._children[0] != null ? assigned_color //    collapsed package
        : d.children ? "white" // expanded package
        : assigned_color;
}

function colornode_fill(d) {
    var subject_domain = d.path.split("/")[1];
    var color_code = subject_list.indexOf(subject_domain);
    var assigned_color = color_scheme_array[color_code];
    var d3_color = d3.rgb(assigned_color);
    return d._children &&  d._children[0] != null ? assigned_color //    collapsed package
        : d.children && d.kind != "Subject" ? "white" // expanded package
        : d.progress == 100 && !d.children ? assigned_color // completed leaf node
        : d.progress == 0 && !d.children ? "white"  // fresh leaf node
        : d.kind != "Subject" ? d3_color.brighter(1.9) // inprogress leaf node
        : assigned_color;
}

function colornode_stroke(d) {
    var subject_domain = d.path.split("/")[1];
    var color_code = subject_list.indexOf(subject_domain);
    var assigned_color = color_scheme_array[color_code];
    return assigned_color;
}

function colorline(d) {
  var subject_domain = d.source.path.split("/")[1];
  var color_code = subject_list.indexOf(subject_domain);
  var assigned_color = color_scheme_array[color_code];
  return assigned_color;
}

var highlight_recover_color;
var recover_node_holder = [];
var recover_link_holder = [];

function highlight_path(d) {
  highlight_recover_color = d3.select(this).select("circle").attr("stroke");

  d3.select(this).select("circle")
    .attr("stroke", "#00FF00");
  d3.select(this).select("rect")
    .attr("stroke", "#00FF00");

  recover_node_holder.push(d3.select(this));

  var path_array = d.path.split("/");
  var source_curr;
  var target_curr;
  for (var i = 0; i < path_array.length -2; i++){
    target_curr = path_array[i];
    var matched_link = links_table[source_curr + ',' + target_curr];
    if(matched_link){
      matched_link.setAttribute("stroke", "#00FF00");
      recover_link_holder.push(matched_link);
    }
    source_curr = path_array[i];

    for( var n = 0; n < node[0].length; n++){
      if(path_array[i] == node[0][n].__data__.slug && node[0][n].__data__.kind !== "Video" && node[0][n].__data__.kind !== "Exercise"){
        node[0][n].getElementsByTagName("circle")[0].setAttribute("stroke", "#00FF00");
        node[0][n].getElementsByTagName("rect")[0].setAttribute("stroke", "#00FF00");
        recover_node_holder.push(node[0][n]);
      }
    }
  }
  matched_link = links_table[source_curr + ',' + d.slug];
  if(matched_link){
    matched_link.setAttribute("stroke", "#00FF00");
    recover_link_holder.push(matched_link);
  }
}


function recover_highlight(d){
  var end_link = recover_node_holder.shift();
  end_link.select("circle").attr("stroke", highlight_recover_color);
  end_link.select("rect").attr("stroke", highlight_recover_color);

  for(var h in recover_node_holder){
    recover_node_holder[h].getElementsByTagName("circle")[0].setAttribute("stroke", highlight_recover_color);
    recover_node_holder[h].getElementsByTagName("rect")[0].setAttribute("stroke", highlight_recover_color);
  }
  for(var j in recover_link_holder){
    recover_link_holder[j].setAttribute("stroke", highlight_recover_color);
  }
  recover_node_holder.length = 0;
  recover_link_holder.length = 0;
}

// Toggle children on click.
function click(d) {
  d.fixed = true;
  setTimeout(function(){ d.fixed = false; }, 3000);
if (d3.event.defaultPrevented) return; // ignore drag
  var update_color = text_fill(d);
  d3.select(this).select("text")
    .style("fill", update_color);

    if (d.children) {
      if(d._children && d._children[0] != null){
        for(var i in d._children){
          d.children.push(d._children[i]);
        }
        d._children = null;
      }else{
        d._children = d.children;
        d.children = null;
    }
  } else {
      if(!d._children){
          location.href = "http://localhost:9011/learn/"+ d.path;
      }
      d.children = d._children;
      d._children = null;
  }
  update();
}

function initial(root) {
    var nodes = [], index = 0;
    function process_topics(node){
      if(node.children) node.children.forEach(process_topics);
      if(node.children){
        var topic_progress = 0;
        var unfold_flag = false;
        var inprogress_node_encounter = 0;
        var fresh_node_encounter = 0;
        var complete_node_encounter = 0;
        for(var i in node.children){

          //because same exercise can appear under different topics, use the path + kind to define a unique id
          node.children[i]["unique_id"] = node.children[i].path + node.children[i].kind;

          if(node.children[i].progress){
            var progress_val = node.children[i].progress;
          }else{
            var progress_val = 0;
          }
        
          var match_hashtable = user_hashtable[node.children[i].id];
          if(match_hashtable){
            progress_val = match_hashtable.streak_progress;
          }
          //update topics.json's end node with personal streak_progress
          if(!node.children[i].children){
            node.children[i]["progress"] = progress_val;
          }

          topic_progress += progress_val;

          if(!node.children[i].children){
            if(progress_val == 100){
              complete_node_encounter++;
            }else if(progress_val == 0){
              fresh_node_encounter++;
            }else{
              inprogress_node_encounter++;
            }
          }
        }
        if(inprogress_node_encounter > 0){
          unfold_flag = true;
        }else if(complete_node_encounter != 0 && fresh_node_encounter != 0){
          unfold_flag = true;
        }
        var total_progress = node.children.length * 100;

        node["progress"] = topic_progress / total_progress * 100;

        node["unfold_flag"] = unfold_flag;
      }
    }
    process_topics(root);

    //prepare the subject nodes
    for(var y in root.children){
      root.children[y]["size"] = 50;   //make subject nodes larger
      root.children[y]["kind"] = "Subject";   //update the kind
      //prevent 100 or 0 progress subject node not shown #1
      if(root.children[y].progress == 100 || root.children[y].progress == 0){
        nodes.push(root.children[y]);
      }
    }

    function recurse(node) {
      if (node.children) node.children.forEach(recurse);
      if(node.children){
        if(node.unfold_flag){
          nodes.push(node)
          for(var t in node.children){
            nodes.push(node.children[t]);
          }
        }else if(node.progress != 0 && node.progress != 100){
          nodes.push(node);
        }
      }

      if (node.children && !node.unfold_flag){
        node["_children"] = [];
        for(var h = node.children.length -1; h >= 0 ; h--){
          if(node.children[h].progress == 0 || node.children[h].progress == 100){
            node._children.push(node.children[h]);
            node.children.splice(h, 1);
          }
        }
      }
    }
  recurse(root);

  //prevent 100 progress subject node not shown #2
  if(root._children){
    root.children = root.children.concat(root._children);
    root._children = null;
  }
  return nodes;
}
{% endblock content %}
